import numpy as np
import pandas as pd
import scipy.optimize as sco
import covidfuncs.datfuncs as cvdf


def add_log(covid_df, col):
    """
    Add the logarithm to the dataframe
    """

    covid_df[col + " (Log)"] = covid_df[col].apply(np.log10)


def add_growth_factor(covid_df, col):
    """
    Add the growth factor to the dataframe

    Take into account time differencs
    """

    facs = covid_df[col] / covid_df[col].shift(1)

    x = cvdf.get_x(covid_df)
    difx = x["x"] - x["x"].shift(1)

    covid_df[col + " (Growth Factor)"] = facs**(1 / difx)


def add_exponential_fit(covid_df, col, startdat):
    """
    Add the exponential fit to the dataframe
    """

    fit = get_log_fit(covid_df, col, startdat)

    x = cvdf.get_x(covid_df)

    covid_df[col + " Fit (Log)"] = pd.Series(fit(x["x"]), index=covid_df.index)
    covid_df[col + " Fit (Exp)"] = pd.Series(
        np.exp(np.log(10) * fit(x["x"])),
        index=covid_df.index,
    )
    add_growth_factor(covid_df, col + " Fit (Exp)")


def get_log_fit(covid_df, col, startdat):
    """
    Get the exponential fit function from the dataframe
    """
    if not col + " (Log)" in covid_df.columns:
        add_log(covid_df, col)

    x = cvdf.get_x(covid_df)

    fit = np.poly1d(
        np.polyfit(x[startdat:]["x"], covid_df[col + " (Log)"][startdat:], 1))

    return fit


# Logistic curve
def logistic(x, L, k, x0, y0):
    return L / (1. + np.exp(-k * (x - x0))) + y0


def get_logistic_fit(covid_df, col, startdat):
    """
    Get the logistic fit function from the dataframe
    """

    x = cvdf.get_x(covid_df)

    L, k, x0, y0 = sco.curve_fit(
        logistic,
        x[startdat:]["x"],
        covid_df[col][startdat:],
        method="trf",
        p0=[8000.0, 0.5, 10.0, 0.0],
        sigma=[1.0 for i in range(len(covid_df[col][startdat:].index))],
        absolute_sigma=True,
        check_finite=True)[0]

    return L, k, x0, y0


def add_logistic_fit(covid_df, col, startdat):
    """
    Add the logistic fit to the dataframe
    """

    x = cvdf.get_x(covid_df)

    L, k, x0, y0 = get_logistic_fit(covid_df, col, startdat)

    covid_df[col + " Fit (Logistic)"] = logistic(x, L, k, x0, y0)


def add_diff(covid_df, col):
    """
    Add additional infections scaled to days
    """

    x = cvdf.get_x(covid_df)

    covid_df[col + " Diff"] = covid_df[col].diff() / x["x"].diff()
