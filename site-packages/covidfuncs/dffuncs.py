import numpy as np
import pandas as pd
import covidfuncs.datfuncs as cvdf


def add_log(covid_df, col):
    """
    Add the logarithm to the dataframe
    """

    covid_df[col+" (Log)"] = covid_df[col].apply(np.log10)

    return covid_df


def add_growth_factor(covid_df, col):
    """
    Add the growth factor to the dataframe
    """

    covid_df[col+" (Growth Factor)"] = covid_df[col] / covid_df[col].shift(1)

    return covid_df


def add_exponential_fit(covid_df, col, startdat):
    """
    Add the exponential fit to the dataframe
    """
    x_dates = pd.DataFrame([
                            cvdf.dat_to_int(dat) for dat in
                            [pd.Timestamp("2019/01/01") + pd.Timedelta(days=i) for i in range(731)]
                            ],
                           index=[
                                  pd.Timestamp("2019/01/01") + pd.Timedelta(days=i)
                                  for i in range(731)
                                  ],
                           columns=["x"])

    x = x_dates[covid_df.index[0]:covid_df.index[-1]]

    fit = np.poly1d(
        np.polyfit(x[startdat:]["x"],
                   covid_df[col+" (Log)"][startdat:], 1))

    covid_df["Fit (Log)"] = pd.Series(fit(x["x"]),
                                        index=covid_df.index)
    covid_df["Fit (Exp)"] = pd.Series(
        np.exp(np.log(10) * fit(x["x"])),
        index=covid_df.index,
    )
    covid_df["Fit (Growth Factor)"] = covid_df[
        "Fit (Exp)"] / covid_df["Fit (Exp)"].shift(1)
